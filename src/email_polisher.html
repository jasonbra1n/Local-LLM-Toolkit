<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Polisher</title>
    <link rel="stylesheet" href="style.css">
    <script src="utils.js"></script>
    <style>
        :root {
            --accent-color: #cba6f7; /* Lavender for communication */
            --button-hover: #b4befe;
        }
        .container { max-width: 800px; }
    </style>
</head>
<body>
<div class="container">
    <a href="index.html" class="back-link">‚Üê Back to Dashboard</a>
    <h1>üìß Email Polisher</h1>
    <!-- Status Bar -->
    <div class="status-bar">
        <div><span id="status-dot" class="status-indicator"></span><span id="status-text">Checking LM Studio...</span></div>
        <div style="font-size: 0.8em; opacity: 0.7;">Target: 127.0.0.1:1234</div>
    </div>

    <!-- Inputs -->
    <div class="input-group">
        <label>Select Model:</label>
        <select id="model-select"><option value="local-model">Loading...</option></select>
    </div>

    <div class="input-group">
        <label>Desired Tone:</label>
        <select id="tone-select">
            <option value="Professional">Professional (Default)</option>
            <option value="Friendly & Empathetic">Friendly & Empathetic</option>
            <option value="Stern & Direct">Stern & Direct</option>
            <option value="Concise & Action-Oriented">Concise & Action-Oriented</option>
            <option value="Casual">Casual</option>
        </select>
    </div>

    <div class="input-group">
        <label>Draft Content (Rough Notes):</label>
        <textarea id="draft-input" rows="8" placeholder="e.g. Hi boss, I cant come in today, sick. Will send report later."></textarea>
    </div>

    <!-- Controls -->
    <button id="generate-btn" onclick="polishEmail()">
        <span id="btn-text">Polish Email</span>
        <div id="loader" class="loader"></div>
    </button>
    <button id="stop-btn" class="stop-btn" onclick="stopGeneration()">Stop Generation</button>

    <!-- Output -->
    <div class="output-area" id="output-container" style="display:none;">
        <button class="copy-btn" onclick="copyToClipboard()">Copy</button>
        <div id="thinking-container" style="display:none;">
            <div class="thinking-header" onclick="toggleThinking()">Reasoning Process</div>
            <div id="thinking-content" class="thinking-box"></div>
        </div>
        <label>Polished Draft:</label>
        <textarea id="result-output" rows="12" readonly></textarea>
    </div>
</div>

<script>
    // Config & System Prompt
    function getConfig() {
        const provider = localStorage.getItem('active_provider') || 'lm-studio';
        let base = "";
        if (provider === 'ollama') base = localStorage.getItem('ollama_url') || "http://127.0.0.1:11434/v1";
        else base = localStorage.getItem('lm_studio_url') || "http://127.0.0.1:1234/v1";
        return { provider, base, temp: parseFloat(localStorage.getItem('global_temperature')) || 0.7 };
    }

    const POLISHER_PROMPT = `You are an expert communication coach and editor.
    Your task is to rewrite the user's email draft to match a specific TONE.
    
    Rules:
    1. Fix all grammar and spelling errors.
    2. Improve clarity and flow.
    3. Strictly adhere to the requested TONE.
    4. Do not add placeholders like "[Your Name]" unless necessary.
    5. Output ONLY the rewritten email body (and subject line if applicable). Do not include conversational filler.`;

    let abortController = null;

    // Window Load (Connection Check)
    window.onload = async () => {
        const { provider, base } = getConfig();
        if (provider === 'gemini') {
            document.getElementById('status-text').innerText = "Gemini Connected";
            const model = localStorage.getItem('gemini_model') || "gemini-1.5-flash";
            document.getElementById('model-select').innerHTML = `<option value="${model}">${model}</option>`;
            document.getElementById('status-dot').classList.add('online');
            return;
        }
        try {
            const res = await fetch(`${base}/models`);
            if(res.ok) {
                const data = await res.json();
                const sel = document.getElementById('model-select');
                if (data.data?.length) { sel.innerHTML = ''; data.data.forEach(m => { let o = document.createElement('option'); o.value = m.id; o.text = m.id; sel.appendChild(o); }); }
                document.getElementById('status-dot').classList.add('online'); document.getElementById('status-text').innerText = "LM Studio Connected";
            }
        } catch (e) { document.getElementById('status-text').innerText = "Error: Enable CORS in LM Studio"; }
    };

    // Generate Function
    async function polishEmail() {
        const { provider, base, temp } = getConfig();
        const draft = document.getElementById('draft-input').value;
        const tone = document.getElementById('tone-select').value;
        const model = document.getElementById('model-select').value;

        if (!draft) return alert("Please enter a draft first.");

        // UI Setup
        const btn = document.getElementById('generate-btn');
        const loader = document.getElementById('loader');
        const out = document.getElementById('output-container');
        const resArea = document.getElementById('result-output');
        const thinkBox = document.getElementById('thinking-container');
        const thinkContent = document.getElementById('thinking-content');
        const stopBtn = document.getElementById('stop-btn');

        const userMessage = `Tone: ${tone}\n\nDraft:\n${draft}`;

        // Gemini Path
        if (provider === 'gemini') {
            const apiKey = localStorage.getItem('gemini_api_key');
            btn.disabled = true; document.getElementById('btn-text').style.display = 'none'; loader.style.display = 'block'; stopBtn.style.display = 'block';
            resArea.value = ""; thinkContent.textContent = ""; thinkBox.style.display = 'none'; out.style.display = 'none';

            await generateGemini(
                [{ role: "system", content: POLISHER_PROMPT }, { role: "user", content: userMessage }],
                model, apiKey,
                (chunk) => { out.style.display = 'block'; resArea.value += chunk; resArea.scrollTop = resArea.scrollHeight; },
                () => { btn.disabled = false; document.getElementById('btn-text').style.display = 'inline'; loader.style.display = 'none'; stopBtn.style.display = 'none'; },
                (err) => { alert(err.message); btn.disabled = false; document.getElementById('btn-text').style.display = 'inline'; loader.style.display = 'none'; stopBtn.style.display = 'none'; }
            );
            return;
        }

        // Local Path
        btn.disabled = true; document.getElementById('btn-text').style.display = 'none'; loader.style.display = 'block'; stopBtn.style.display = 'block';
        out.style.display = 'none'; resArea.value = ""; thinkContent.textContent = ""; thinkBox.style.display = 'none';
        
        abortController = new AbortController();

        try {
            const response = await fetch(`${base}/chat/completions`, {
                method: "POST", headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    model: model,
                    messages: [{ role: "system", content: POLISHER_PROMPT }, { role: "user", content: userMessage }],
                    temperature: temp, max_tokens: -1, stream: true
                }),
                signal: abortController.signal
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let isThinking = false;
            out.style.display = 'block';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n');
                for (const line of lines) {
                    if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                        try {
                            const json = JSON.parse(line.slice(6));
                            const content = json.choices[0]?.delta?.content || "";
                            if (!content) continue;

                            if (!isThinking && content.includes('<think>')) {
                                isThinking = true; thinkBox.style.display = 'block';
                                const parts = content.split('<think>');
                                if(parts[0]) resArea.value += parts[0]; if(parts[1]) thinkContent.textContent += parts[1];
                            } else if (isThinking && content.includes('</think>')) {
                                isThinking = false;
                                const parts = content.split('</think>');
                                if(parts[0]) thinkContent.textContent += parts[0]; if(parts[1]) resArea.value += parts[1];
                            } else if (isThinking) { thinkContent.textContent += content; thinkContent.scrollTop = thinkContent.scrollHeight;
                            } else { resArea.value += content; resArea.scrollTop = resArea.scrollHeight; }
                        } catch (e) { console.error(e); }
                    }
                }
            }
        } catch (e) {
            if (e.name === 'AbortError') resArea.value += "\n\n[Stopped]";
            else alert("Error: " + e.message);
        } finally {
            btn.disabled = false; document.getElementById('btn-text').style.display = 'inline'; loader.style.display = 'none'; stopBtn.style.display = 'none'; abortController = null;
        }
    }

    function stopGeneration() { if (abortController) abortController.abort(); }
    function toggleThinking() {
        const h = document.querySelector('.thinking-header'); const c = document.getElementById('thinking-content');
        h.classList.toggle('collapsed'); c.style.display = h.classList.contains('collapsed') ? 'none' : 'block';
    }
    function copyToClipboard() {
        const copyText = document.getElementById("result-output");
        copyText.select(); navigator.clipboard.writeText(copyText.value); alert("Copied!");
    }
</script>
</body>
</html>