<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings</title>
    <link rel="stylesheet" href="style.css">
    <script src="utils.js"></script>
    <script src="layout.js"></script>
    <style>
        .container {
            max-width: 600px;
        }
        /* Tabs */
        .tabs { display: flex; border-bottom: 1px solid #45475a; margin-bottom: 20px; }
        .tab-btn { 
            background: none; border: none; border-bottom: 2px solid transparent; 
            color: var(--text-color); padding: 10px 20px; cursor: pointer; font-size: 1rem; opacity: 0.7;
            width: auto; border-radius: 0;
        }
        .tab-btn:hover { background: rgba(255,255,255,0.05); }
        .tab-btn.active { border-bottom-color: var(--accent-color); opacity: 1; font-weight: bold; }
        .tab-content { display: none; animation: fadeIn 0.2s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        h3 { border-bottom: 1px solid #45475a; padding-bottom: 10px; margin-top: 0; color: var(--text-color); }
        .provider-section { display: none; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 20px; }
        .provider-section.active { display: block; }
        .note { font-size: 0.8rem; opacity: 0.7; margin-top: -10px; margin-bottom: 15px; display: block; }
    </style>
</head>
<body>
<div class="container">
    <h1>Settings</h1>
    
    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('providers')">üîå Providers</button>
        <button class="tab-btn" onclick="openTab('general')">‚öôÔ∏è General</button>
    </div>

    <!-- Tab 1: Providers -->
    <div id="providers" class="tab-content active">
        <label>Active AI Provider:</label>
        <select id="provider-select" onchange="updateProviderUI()">
            <optgroup label="Local (Privacy Focused)">
                <option value="lm-studio">LM Studio</option>
                <option value="ollama">Ollama</option>
            </optgroup>
            <optgroup label="Cloud (Requires API Key)">
                <option value="gemini">Google Gemini</option>
                <option value="openai">OpenAI</option>
                <option value="groq">Groq</option>
                <option value="deepseek">DeepSeek</option>
                <option value="mistral">Mistral AI</option>
            </optgroup>
        </select>

        <!-- LM Studio Config -->
        <div id="lm-studio-config" class="provider-section">
            <label>Base URL:</label>
            <input type="text" id="lm-url" placeholder="http://127.0.0.1:1234/v1">
            <span class="note">Default: http://127.0.0.1:1234/v1</span>
            <label style="margin-top: 10px; display: block;">Default Model ID (Optional):</label>
            <div style="display: flex; gap: 10px; margin-bottom: 20px; align-items: center;">
                <select id="lm-model" style="flex: 1; margin-bottom: 0;"><option value="">Loading...</option></select>
                <button onclick="fetchLocalModels()" style="width: auto; padding: 8px 15px;">üîÑ Refresh</button>
            </div>
            <span class="note">If set, tools will auto-select this model. Click Refresh to list available models.</span>
        </div>

        <!-- Ollama Config -->
        <div id="ollama-config" class="provider-section">
            <label>Base URL:</label>
            <input type="text" id="ollama-url" placeholder="http://127.0.0.1:11434/v1">
            <span class="note">Default: http://127.0.0.1:11434/v1</span>
        </div>

        <!-- Gemini Config -->
        <div id="gemini-config" class="provider-section">
            <label>API Key:</label>
            <input type="password" id="gemini-key" placeholder="AIzaSy...">
            <span class="note">Get a free key from Google AI Studio.</span>
            <label style="margin-top: 10px; display: block;">Model ID:</label>
            <input type="text" id="gemini-model" placeholder="gemini-1.5-flash">
            <span class="note">Default: gemini-1.5-flash</span>
        </div>

        <!-- OpenAI Config -->
        <div id="openai-config" class="provider-section">
            <label>API Key:</label>
            <input type="password" id="openai-key" placeholder="sk-...">
            <label style="margin-top: 10px; display: block;">Model ID:</label>
            <input type="text" id="openai-model" placeholder="gpt-4o">
            <span class="note">Default: gpt-4o</span>
            <input type="hidden" id="openai-url" value="https://api.openai.com/v1">
        </div>

        <!-- Groq Config -->
        <div id="groq-config" class="provider-section">
            <label>API Key:</label>
            <input type="password" id="groq-key" placeholder="gsk_...">
            <label style="margin-top: 10px; display: block;">Model ID:</label>
            <input type="text" id="groq-model" placeholder="llama3-8b-8192">
            <span class="note">Default: llama3-8b-8192</span>
            <input type="hidden" id="groq-url" value="https://api.groq.com/openai/v1">
        </div>

        <!-- DeepSeek Config -->
        <div id="deepseek-config" class="provider-section">
            <label>API Key:</label>
            <input type="password" id="deepseek-key" placeholder="sk-...">
            <label style="margin-top: 10px; display: block;">Model ID:</label>
            <input type="text" id="deepseek-model" placeholder="deepseek-chat">
            <span class="note">Default: deepseek-chat</span>
            <input type="hidden" id="deepseek-url" value="https://api.deepseek.com">
        </div>

        <!-- Mistral Config -->
        <div id="mistral-config" class="provider-section">
            <label>API Key:</label>
            <input type="password" id="mistral-key" placeholder="key...">
            <label style="margin-top: 10px; display: block;">Model ID:</label>
            <input type="text" id="mistral-model" placeholder="mistral-small-latest">
            <span class="note">Default: mistral-small-latest</span>
            <input type="hidden" id="mistral-url" value="https://api.mistral.ai/v1">
        </div>
    </div>

    <!-- Tab 2: General -->
    <div id="general" class="tab-content">
        <h3>Global Defaults</h3>
        <label>Temperature (Creativity): <span id="temp-val">0.7</span></label>
        <input type="range" id="global-temp" min="0" max="1" step="0.1" value="0.7" style="width:100%; margin-bottom: 20px;" oninput="document.getElementById('temp-val').innerText = this.value">

        <label>Default System Prompt (Chat Interface):</label>
        <textarea id="system-prompt" rows="3" placeholder="You are a helpful AI assistant."></textarea>

        <h3>Text-to-Speech (TTS)</h3>
        <label>TTS Provider:</label>
        <select id="tts-provider" onchange="updateTTSUI()" style="margin-bottom: 20px;">
            <option value="browser">Browser Native (Free, Offline)</option>
            <option value="openai">OpenAI (High Quality, Paid)</option>
            <option value="local">Local Server (AllTalk/Piper)</option>
        </select>

        <!-- Browser Config -->
        <div id="tts-browser-config">
            <label>Voice:</label>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <select id="voice-select" style="flex: 1; margin-bottom: 0;">
                    <option value="">Default / Browser Choice</option>
                </select>
                <button onclick="testVoice()" style="width: auto; padding: 10px;">üîä Test</button>
            </div>
        </div>

        <!-- External Config -->
        <div id="tts-external-config" style="display:none;">
            <label>API Endpoint:</label>
            <input type="text" id="tts-url" placeholder="https://api.openai.com/v1/audio/speech">
            <label>API Key (Optional for Local):</label>
            <input type="password" id="tts-key" placeholder="sk-...">
            <div class="row">
                <div class="col">
                    <label>Model ID:</label>
                    <input type="text" id="tts-model" placeholder="tts-1">
                </div>
                <div class="col">
                    <label>Voice ID:</label>
                    <input type="text" id="tts-ext-voice" placeholder="alloy">
                </div>
            </div>
            <span class="note">OpenAI Voices: alloy, echo, fable, onyx, nova, shimmer</span>
            <button onclick="testVoice()" style="width: 100%; margin-top: 10px;">üîä Test External TTS</button>
        </div>
    </div>

    <button onclick="saveSettings()" style="margin-top: 20px;">Save Settings</button>
</div>
<script>
    window.onload = async () => {
        // Load Provider
        const provider = localStorage.getItem('active_provider') || 'lm-studio';
        document.getElementById('provider-select').value = provider;

        // Load Values
        document.getElementById('lm-url').value = localStorage.getItem('lm_studio_url') || "http://127.0.0.1:1234/v1";
        document.getElementById('ollama-url').value = localStorage.getItem('ollama_url') || "http://127.0.0.1:11434/v1";
        document.getElementById('gemini-key').value = localStorage.getItem('gemini_api_key') || "";
        document.getElementById('gemini-model').value = localStorage.getItem('gemini_model') || "gemini-1.5-flash";
        document.getElementById('global-temp').value = localStorage.getItem('global_temperature') || "0.7";
        document.getElementById('system-prompt').value = localStorage.getItem('default_system_prompt') || "You are a helpful AI assistant.";
        
        // Cloud Providers
        document.getElementById('openai-key').value = localStorage.getItem('openai_api_key') || "";
        document.getElementById('openai-model').value = localStorage.getItem('openai_model') || "gpt-4o";
        
        document.getElementById('groq-key').value = localStorage.getItem('groq_api_key') || "";
        document.getElementById('groq-model').value = localStorage.getItem('groq_model') || "llama3-8b-8192";
        
        document.getElementById('deepseek-key').value = localStorage.getItem('deepseek_api_key') || "";
        document.getElementById('deepseek-model').value = localStorage.getItem('deepseek_model') || "deepseek-chat";
        
        document.getElementById('mistral-key').value = localStorage.getItem('mistral_api_key') || "";
        document.getElementById('mistral-model').value = localStorage.getItem('mistral_model') || "mistral-small-latest";

        document.getElementById('temp-val').innerText = document.getElementById('global-temp').value;

        // TTS
        document.getElementById('tts-provider').value = localStorage.getItem('tts_provider') || 'browser';
        document.getElementById('tts-url').value = localStorage.getItem('tts_url') || "";
        document.getElementById('tts-key').value = localStorage.getItem('tts_api_key') || "";
        document.getElementById('tts-model').value = localStorage.getItem('tts_model') || "tts-1";
        document.getElementById('tts-ext-voice').value = localStorage.getItem('tts_voice') || "alloy";

        updateProviderUI();
        updateTTSUI();
        fetchLocalModels(); // Auto-fetch on load

        // Initialize Status Bar
        const config = getConfig();
        if(document.getElementById('target-display')) document.getElementById('target-display').innerText = `Target: ${config.base}`;
        await loadModels(config);

        if ('speechSynthesis' in window) {
            window.speechSynthesis.onvoiceschanged = loadVoices;
            loadVoices();
        }
    };

    function openTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        // Show selected
        document.getElementById(tabName).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    function updateProviderUI() {
        const provider = document.getElementById('provider-select').value;
        document.querySelectorAll('.provider-section').forEach(el => el.classList.remove('active'));
        document.getElementById(`${provider}-config`).classList.add('active');
    }

    function updateTTSUI() {
        const provider = document.getElementById('tts-provider').value;
        if (provider === 'browser') {
            document.getElementById('tts-browser-config').style.display = 'block';
            document.getElementById('tts-external-config').style.display = 'none';
        } else {
            document.getElementById('tts-browser-config').style.display = 'none';
            document.getElementById('tts-external-config').style.display = 'block';
            
            const urlInput = document.getElementById('tts-url');
            if (provider === 'openai' && !urlInput.value) {
                urlInput.value = "https://api.openai.com/v1/audio/speech";
            } else if (provider === 'local' && !urlInput.value) {
                urlInput.value = "http://127.0.0.1:8000/v1/audio/speech";
            }
        }
    }

    async function fetchLocalModels() {
        const url = document.getElementById('lm-url').value.replace(/\/+$/, "");
        const select = document.getElementById('lm-model');
        const savedModel = localStorage.getItem('lm_studio_model') || "";
        
        select.innerHTML = '<option value="">Checking connection...</option>';
        
        try {
            const response = await fetch(`${url}/models`);
            if (response.ok) {
                const data = await response.json();
                select.innerHTML = '<option value="">-- Select Default Model --</option>';
                
                if (data.data && data.data.length > 0) {
                    data.data.forEach(m => {
                        const option = document.createElement('option');
                        option.value = m.id;
                        option.text = m.id;
                        if (m.id === savedModel) option.selected = true;
                        select.appendChild(option);
                    });
                }
                
                // If saved model exists but isn't in the list (e.g. different server state), add it
                if (savedModel && !Array.from(select.options).some(o => o.value === savedModel)) {
                    const option = document.createElement('option');
                    option.value = savedModel;
                    option.text = `${savedModel} (Saved)`;
                    option.selected = true;
                    select.appendChild(option);
                }
            } else {
                select.innerHTML = `<option value="${savedModel}">${savedModel || "Connection Error"}</option>`;
            }
        } catch (e) {
            select.innerHTML = `<option value="${savedModel}">${savedModel || "Offline / CORS Error"}</option>`;
        }
    }

    function loadVoices() {
        const voiceSelect = document.getElementById('voice-select');
        const savedVoice = localStorage.getItem('preferred_voice_name');
        
        // Keep the default option
        voiceSelect.innerHTML = '<option value="">Default / Browser Choice</option>';

        if ('speechSynthesis' in window) {
            const voices = window.speechSynthesis.getVoices();
            voices.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.name;
                option.textContent = `${voice.name} (${voice.lang})`;
                if (voice.name === savedVoice) option.selected = true;
                voiceSelect.appendChild(option);
            });
        }
    }

    function saveSettings() {
        const provider = document.getElementById('provider-select').value;
        localStorage.setItem('active_provider', provider);
        
        localStorage.setItem('lm_studio_url', document.getElementById('lm-url').value.replace(/\/+$/, ""));
        localStorage.setItem('lm_studio_model', document.getElementById('lm-model').value.trim());
        localStorage.setItem('ollama_url', document.getElementById('ollama-url').value.replace(/\/+$/, ""));
        localStorage.setItem('gemini_api_key', document.getElementById('gemini-key').value.trim());
        localStorage.setItem('gemini_model', document.getElementById('gemini-model').value.trim() || "gemini-1.5-flash");
        localStorage.setItem('global_temperature', document.getElementById('global-temp').value);
        localStorage.setItem('default_system_prompt', document.getElementById('system-prompt').value.trim());

        // Save Cloud Providers
        localStorage.setItem('openai_api_key', document.getElementById('openai-key').value.trim());
        localStorage.setItem('openai_model', document.getElementById('openai-model').value.trim() || "gpt-4o");
        localStorage.setItem('openai_url', document.getElementById('openai-url').value);

        localStorage.setItem('groq_api_key', document.getElementById('groq-key').value.trim());
        localStorage.setItem('groq_model', document.getElementById('groq-model').value.trim() || "llama3-8b-8192");
        localStorage.setItem('groq_url', document.getElementById('groq-url').value);

        localStorage.setItem('deepseek_api_key', document.getElementById('deepseek-key').value.trim());
        localStorage.setItem('deepseek_model', document.getElementById('deepseek-model').value.trim() || "deepseek-chat");
        localStorage.setItem('deepseek_url', document.getElementById('deepseek-url').value);

        localStorage.setItem('mistral_api_key', document.getElementById('mistral-key').value.trim());
        localStorage.setItem('mistral_model', document.getElementById('mistral-model').value.trim() || "mistral-small-latest");
        localStorage.setItem('mistral_url', document.getElementById('mistral-url').value);

        localStorage.setItem('preferred_voice_name', document.getElementById('voice-select').value);
        
        // TTS
        localStorage.setItem('tts_provider', document.getElementById('tts-provider').value);
        localStorage.setItem('tts_url', document.getElementById('tts-url').value.trim());
        localStorage.setItem('tts_api_key', document.getElementById('tts-key').value.trim());
        localStorage.setItem('tts_model', document.getElementById('tts-model').value.trim());
        localStorage.setItem('tts_voice', document.getElementById('tts-ext-voice').value.trim());

        alert("Settings Saved!");
    }

    async function testVoice() {
        const provider = document.getElementById('tts-provider').value;
        const text = "This is a test of the selected voice.";
        
        if (provider === 'browser') {
            if (!('speechSynthesis' in window)) return alert("TTS not supported.");
            const utterance = new SpeechSynthesisUtterance(text);
            const voiceName = document.getElementById('voice-select').value;
            const voices = window.speechSynthesis.getVoices();
            const selectedVoice = voices.find(v => v.name === voiceName);
            if (selectedVoice) utterance.voice = selectedVoice;
            window.speechSynthesis.speak(utterance);
        } else {
            const url = document.getElementById('tts-url').value;
            const key = document.getElementById('tts-key').value;
            const model = document.getElementById('tts-model').value;
            const voice = document.getElementById('tts-ext-voice').value;
            
            try {
                const headers = { "Content-Type": "application/json" };
                if (key) headers["Authorization"] = `Bearer ${key}`;
                
                const response = await fetch(url, {
                    method: "POST",
                    headers: headers,
                    body: JSON.stringify({ model, input: text, voice })
                });
                
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                
                const blob = await response.blob();
                const audio = new Audio(URL.createObjectURL(blob));
                audio.play();
            } catch (e) {
                alert("TTS Test Failed: " + e.message);
            }
        }
    }
</script>
</body>
</html>