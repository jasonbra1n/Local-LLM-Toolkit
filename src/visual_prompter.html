<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Prompter</title>
    <link rel="stylesheet" href="style.css">
    <script src="utils.js"></script>
    <script src="layout.js"></script>
    <style>
        :root {
            --accent-color: #f38ba8; /* Red/Pink for Visual Arts */
            --button-hover: #eba0ac;
        }
        .container { max-width: 900px; }
    </style>
</head>
<body>
<div class="container">
    <h1>üé® Visual Prompter</h1>

    <div class="info-box">
        <strong>‚ÑπÔ∏è Workflow:</strong> Describe your image or video concept simply. The AI will expand it into a highly detailed technical prompt optimized for your target model (Midjourney, Stable Diffusion, Runway, etc.).
    </div>

    <div class="input-group">
        <label>Select Local Model:</label>
        <select id="model-select"><option value="local-model">Loading...</option></select>
    </div>

    <div class="row input-group">
        <div class="col">
            <label>Target Platform:</label>
            <select id="platform-select">
                <option value="Midjourney v6">Midjourney v6 (Photorealistic)</option>
                <option value="Midjourney Niji">Midjourney Niji (Anime)</option>
                <option value="Stable Diffusion XL">Stable Diffusion XL</option>
                <option value="DALL-E 3">DALL-E 3</option>
                <option value="Runway Gen-2">Runway Gen-2 (Video)</option>
                <option value="Pika Labs">Pika Labs (Video)</option>
            </select>
        </div>
        <div class="col">
            <label>Aspect Ratio:</label>
            <select id="ratio-select">
                <option value="16:9">16:9 (Cinematic)</option>
                <option value="1:1">1:1 (Square)</option>
                <option value="9:16">9:16 (Mobile/Portrait)</option>
                <option value="21:9">21:9 (Ultrawide)</option>
                <option value="4:3">4:3 (TV/Classic)</option>
            </select>
        </div>
    </div>

    <div class="input-group">
        <label>Core Concept / Subject:</label>
        <textarea id="concept-input" rows="4" placeholder="e.g. A cyberpunk detective standing in the rain..."></textarea>
    </div>

    <button id="generate-btn" onclick="generateVisualPrompt()">
        <span id="btn-text">Generate Visual Prompts</span>
        <div id="loader" class="loader"></div>
    </button>
    <button id="stop-btn" class="stop-btn" onclick="stopGeneration()">Stop Generation</button>

    <div class="output-area" id="output-container" style="display:none;">
        <button class="copy-btn" onclick="copyToClipboard()">Copy</button>
        <button id="speak-btn" class="speak-btn" style="margin-right: 5px;">üîä Listen</button>
        <button id="tts-stop-btn" class="speak-btn" style="margin-right: 5px; display:none;">‚èπÔ∏è Stop</button>
        <div id="thinking-container" style="display:none;">
            <div class="thinking-header" onclick="toggleThinking()">Reasoning Process</div>
            <div id="thinking-content" class="thinking-box"></div>
        </div>
        <label>Optimized Prompts (3 Variations):</label>
        <textarea id="result-output" rows="15" readonly></textarea>
    </div>
</div>

<script>
    const VISUAL_SYSTEM_PROMPT = `You are an expert Visual Prompt Engineer for AI Art and Video generation.
    Your task is to take a simple concept and expand it into highly detailed, professional prompts.
    
    Guidelines:
    1. **Structure**: [Subject] + [Action/Context] + [Art Style/Medium] + [Lighting/Atmosphere] + [Camera/Technical Details].
    2. **Keywords**: Use high-impact keywords (e.g., "volumetric lighting", "8k resolution", "octane render", "cinematic", "photorealistic", "bokeh").
    3. **Platform Specifics**: 
       - If Midjourney: Use --ar [ratio] --v 6.0 --stylize 250.
       - If Stable Diffusion: Focus on comma-separated tags.
       - If Video (Runway/Pika): Include camera movement (e.g., "slow pan", "zoom in").
    4. **Output**: Provide 3 distinct variations (e.g., "Photorealistic", "Stylized/Artistic", "Abstract/Cinematic").
    5. **No Fluff**: Do not include conversational filler. Just the prompts.`;

    let abortController = null;
    let tts = null;

    window.onload = async () => {
        await loadModels(getConfig());
        tts = new TTSController({
            getText: () => document.getElementById('result-output').value,
            labels: { start: "üîä Listen", pause: "‚è∏Ô∏è Pause", resume: "‚ñ∂Ô∏è Resume" }
        });
    };

    async function generateVisualPrompt() {
        const globalConfig = getConfig();
        const concept = document.getElementById('concept-input').value;
        const platform = document.getElementById('platform-select').value;
        const ratio = document.getElementById('ratio-select').value;
        const model = document.getElementById('model-select').value;

        if (!concept) return alert("Please enter a concept.");

        const btn = document.getElementById('generate-btn');
        const loader = document.getElementById('loader');
        const out = document.getElementById('output-container');
        const resArea = document.getElementById('result-output');
        const stopBtn = document.getElementById('stop-btn');
        const thinkBox = document.getElementById('thinking-container');
        const thinkContent = document.getElementById('thinking-content');

        // UI Setup
        btn.disabled = true; document.getElementById('btn-text').style.display = 'none'; loader.style.display = 'block'; stopBtn.style.display = 'block';
        out.style.display = 'block'; resArea.value = ""; thinkContent.textContent = ""; thinkBox.style.display = 'none';

        abortController = new AbortController();

        const config = { ...globalConfig, model: model };
        const userMessage = `Target Platform: ${platform}\nAspect Ratio: ${ratio}\nConcept: ${concept}`;
        const messages = [{ role: "system", content: VISUAL_SYSTEM_PROMPT }, { role: "user", content: userMessage }];

        let isThinking = false;

        await generateText(messages, config,
            (content) => {
                if (!isThinking && content.includes('<think>')) {
                    isThinking = true; thinkBox.style.display = 'block';
                    const parts = content.split('<think>');
                    if(parts[0]) resArea.value += parts[0]; if(parts[1]) thinkContent.textContent += parts[1];
                } else if (isThinking && content.includes('</think>')) {
                    isThinking = false;
                    const parts = content.split('</think>');
                    if(parts[0]) thinkContent.textContent += parts[0]; if(parts[1]) resArea.value += parts[1];
                } else if (isThinking) { thinkContent.textContent += content; thinkContent.scrollTop = thinkContent.scrollHeight;
                } else { resArea.value += content; resArea.scrollTop = resArea.scrollHeight; }
            },
            () => { 
                btn.disabled = false; document.getElementById('btn-text').style.display = 'inline'; loader.style.display = 'none'; stopBtn.style.display = 'none'; abortController = null; 
            },
            (err) => { 
                if (err.name !== 'AbortError') alert(err.message);
                btn.disabled = false; document.getElementById('btn-text').style.display = 'inline'; loader.style.display = 'none'; stopBtn.style.display = 'none'; 
            },
            abortController.signal
        );
    }

    function stopGeneration() { if (abortController) abortController.abort(); if (tts) tts.stop(); }
    function toggleThinking() { const h = document.querySelector('.thinking-header'); const c = document.getElementById('thinking-content'); h.classList.toggle('collapsed'); c.style.display = h.classList.contains('collapsed') ? 'none' : 'block'; }
    function copyToClipboard() { const t = document.getElementById("result-output"); t.select(); navigator.clipboard.writeText(t.value); alert("Copied!"); }
</script>
</body>
</html>