<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Story Architect</title>
    <style>
        :root {
            --bg-color: #1e1e2e;
            --card-bg: #2b2b3f;
            --text-color: #cdd6f4;
            --accent-color: #f9e2af; /* Gold for storytelling */
            --button-hover: #fdf6e3;
            --input-bg: #181825;
        }

        body {
            font-family: 'Georgia', serif; /* Serif for literary feel */
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            padding: 40px;
            margin: 0;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background-color: var(--card-bg);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        h1 {
            margin-top: 0;
            color: var(--accent-color);
            text-align: center;
            font-family: 'Segoe UI', sans-serif;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .status-bar {
            font-family: 'Segoe UI', sans-serif;
            font-size: 0.9rem;
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 6px;
            background-color: var(--input-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ff5555;
            margin-right: 8px;
        }

        .status-indicator.online {
            background-color: #a6e3a1;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            font-family: 'Segoe UI', sans-serif;
            color: var(--accent-color);
        }

        textarea, input[type="text"], select {
            width: 100%;
            background-color: var(--input-bg);
            border: 1px solid #45475a;
            color: var(--text-color);
            padding: 12px;
            border-radius: 6px;
            box-sizing: border-box;
            font-family: inherit;
            resize: vertical;
        }

        .row {
            display: flex;
            gap: 20px;
        }
        
        .col {
            flex: 1;
        }

        button {
            background-color: var(--accent-color);
            color: #1e1e2e;
            border: none;
            padding: 15px 24px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
            width: 100%;
            font-size: 1.1rem;
            font-family: 'Segoe UI', sans-serif;
        }

        button:hover {
            background-color: var(--button-hover);
        }

        button:disabled {
            background-color: #45475a;
            cursor: not-allowed;
        }

        .output-area {
            margin-top: 30px;
            border-top: 1px solid #45475a;
            padding-top: 20px;
        }

        /* Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: none;
            margin: 0 auto;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .thinking-box {
            background-color: #11111b;
            border: 1px solid #45475a;
            border-left: 4px solid var(--accent-color);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
            color: #a6adc8;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        .thinking-header {
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            user-select: none;
        }
        .thinking-header::before {
            content: 'â–¼';
            display: inline-block;
            margin-right: 8px;
            font-size: 0.8em;
            transition: transform 0.2s;
        }
        .thinking-header.collapsed::before {
            transform: rotate(-90deg);
        }

        .stop-btn {
            background-color: #ff5555;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            display: none;
        }
        .stop-btn:hover { background-color: #ff6e6e; }
    </style>
</head>
<body>

<div class="container">
    <h1>Story Architect</h1>
    
    <div class="status-bar">
        <div><span id="status-dot" class="status-indicator"></span><span id="status-text">Checking LM Studio...</span></div>
        <div style="font-size: 0.8em; opacity: 0.7;">Target: 127.0.0.1:1234</div>
    </div>

    <div class="input-group">
        <label>Select Model:</label>
        <select id="model-select"><option value="local-model">Loading models...</option></select>
    </div>

    <div class="input-group">
        <label>Core Premise / Idea:</label>
        <textarea id="premise" rows="3" placeholder="e.g. A detective discovers that the murderer is a time traveler trying to prevent a future war."></textarea>
    </div>

    <div class="row input-group">
        <div class="col">
            <label>Genre & Tone:</label>
            <input type="text" id="genre" placeholder="e.g. Cyberpunk Noir, Gritty">
        </div>
        <div class="col">
            <label>Approx Word Count:</label>
            <input type="text" id="wordcount" placeholder="e.g. 50,000 words">
        </div>
    </div>

    <button id="generate-btn" onclick="generateStory()">
        <span id="btn-text">Generate Story Bible</span>
        <div id="loader" class="loader"></div>
    </button>
    <button id="stop-btn" class="stop-btn" onclick="stopGeneration()">Stop Generation</button>

    <div class="output-area" id="output-container" style="display:none;">
        <div id="thinking-container" style="display:none;">
            <div class="thinking-header" onclick="toggleThinking()">Architect's Reasoning</div>
            <div id="thinking-content" class="thinking-box"></div>
        </div>
        <label>Story Bible (Characters, Plot, Outline):</label>
        <textarea id="result-output" rows="20"></textarea>
    </div>
</div>

<script>
    function getConfig() {
        const provider = localStorage.getItem('active_provider') || 'lm-studio';
        let base = "";
        if (provider === 'ollama') base = localStorage.getItem('ollama_url') || "http://127.0.0.1:11434/v1";
        else base = localStorage.getItem('lm_studio_url') || "http://127.0.0.1:1234/v1";
        
        return { provider, base, temp: parseFloat(localStorage.getItem('global_temperature')) || 0.7 };
    }
    
    const ARCHITECT_PROMPT = `You are a world-class Novelist and Story Editor. 
    Your goal is to take a user's premise and expand it into a comprehensive "Story Bible".
    
    You must output a structured plan including:
    1. **Title Ideas**: 3 catchy options.
    2. **Logline**: A one-sentence summary.
    3. **Character Profiles**: For Protagonist, Antagonist, and key supporting characters (Name, Role, Motivation, Flaw).
    4. **Detailed Chapter Outline**: A breakdown of at least 10-15 chapters. For each chapter, describe the key event and the "Scene Goal".
    5. **Ending**: The desired outcome and resolution.
    
    Format the output in clean Markdown.`;

    let abortController = null;

    window.onload = async () => {
        const { provider, base } = getConfig();
        if (provider === 'gemini') {
            document.getElementById('status-text').innerText = "Gemini Provider Selected (Adapter In Progress)";
            document.getElementById('model-select').innerHTML = '<option>gemini-pro</option>';
            return;
        }

        try {
            const response = await fetch(`${base}/models`);
            if(response.ok) {
                const data = await response.json();
                const select = document.getElementById('model-select');
                if (data.data?.length) {
                    select.innerHTML = ''; 
                    data.data.forEach(m => {
                        let opt = document.createElement('option');
                        opt.value = m.id; opt.text = m.id; select.appendChild(opt);
                    });
                }
                document.getElementById('status-dot').classList.add('online');
                document.getElementById('status-text').innerText = "LM Studio Connected";
            }
        } catch (e) { document.getElementById('status-text').innerText = "Error: Check Settings & CORS"; }
    };

    async function generateStory() {
        const { provider, base, temp } = getConfig();
        const premise = document.getElementById('premise').value;
        const genre = document.getElementById('genre').value;
        const wc = document.getElementById('wordcount').value;
        const model = document.getElementById('model-select').value;

        if (!premise) return alert("Please enter a premise.");

        const btn = document.getElementById('generate-btn');
        const loader = document.getElementById('loader');
        const out = document.getElementById('output-container');
        const thinkingContainer = document.getElementById('thinking-container');
        const thinkingContent = document.getElementById('thinking-content');
        const resultArea = document.getElementById('result-output');
        const stopBtn = document.getElementById('stop-btn');
        
        if (provider === 'gemini') {
            alert("Gemini support is currently in progress. Please switch to LM Studio or Ollama in Settings.");
            return;
        }

        btn.disabled = true; document.getElementById('btn-text').style.display = 'none'; loader.style.display = 'block';
        stopBtn.style.display = 'block';

        abortController = new AbortController();

        const userPrompt = `Premise: ${premise}\nGenre/Tone: ${genre}\nTarget Length: ${wc}\n\nPlease generate the Story Bible now.`;

        try {
            const res = await fetch(`${base}/chat/completions`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        { role: "system", content: ARCHITECT_PROMPT },
                        { role: "user", content: userPrompt }
                    ],
                    temperature: temp, 
                    max_tokens: -1,
                    stream: true
                }),
                signal: abortController.signal
            });

            const reader = res.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let isThinking = false;
            
            resultArea.value = "";
            thinkingContent.textContent = "";
            thinkingContainer.style.display = 'none';
            out.style.display = 'block';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n');
                
                for (const line of lines) {
                    if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                        try {
                            const data = JSON.parse(line.slice(6));
                            const content = data.choices[0]?.delta?.content || "";
                            
                            if (!content) continue;

                            if (!isThinking && content.includes('<think>')) {
                                isThinking = true;
                                thinkingContainer.style.display = 'block';
                                const parts = content.split('<think>');
                                if(parts[0]) resultArea.value += parts[0];
                                if(parts[1]) thinkingContent.textContent += parts[1];
                            } else if (isThinking && content.includes('</think>')) {
                                isThinking = false;
                                const parts = content.split('</think>');
                                if(parts[0]) thinkingContent.textContent += parts[0];
                                if(parts[1]) resultArea.value += parts[1];
                            } else if (isThinking) {
                                thinkingContent.textContent += content;
                                thinkingContent.scrollTop = thinkingContent.scrollHeight;
                            } else {
                                resultArea.value += content;
                                resultArea.scrollTop = resultArea.scrollHeight;
                            }
                        } catch (e) { console.error("Stream parse error", e); }
                    }
                }
            }

        } catch (e) { 
            if (e.name === 'AbortError') {
                resultArea.value += "\n\n[Generation stopped by user]";
            } else {
                alert("Error: " + e.message); 
            }
        } 
        finally { btn.disabled = false; document.getElementById('btn-text').style.display = 'inline'; loader.style.display = 'none'; stopBtn.style.display = 'none'; abortController = null; }
    }

    function stopGeneration() {
        if (abortController) {
            abortController.abort();
        }
    }

    function toggleThinking() {
        const header = document.querySelector('.thinking-header');
        const content = document.getElementById('thinking-content');
        header.classList.toggle('collapsed');
        content.style.display = header.classList.contains('collapsed') ? 'none' : 'block';
    }
</script>
</body>
</html>