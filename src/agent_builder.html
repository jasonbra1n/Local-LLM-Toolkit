<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Builder</title>
    <link rel="stylesheet" href="style.css">
    <script src="utils.js"></script>
    <script src="layout.js"></script>
    <style>
        :root {
            --accent-color: #a6e3a1; /* Green for Agents */
            --button-hover: #94e2d5;
        }

        .container {
            max-width: 900px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Agent Builder</h1>

    <div class="info-box">
        <strong>‚ÑπÔ∏è Tip:</strong> Define an AI Agent's personality and mission here. This tool generates an <code>AGENT.md</code> file that you can use to configure autonomous agents or chatbots.
    </div>

    <div class="input-group"><label>Select Model:</label><select id="model-select"><option value="local-model">Loading...</option></select></div>
    <div class="input-group" style="text-align: right;">
        <input type="file" id="import-file" accept=".md" style="display:none" onchange="loadAgentFile(this)">
        <button onclick="document.getElementById('import-file').click()" style="width: auto; background-color: #45475a; padding: 8px 15px; font-size: 0.9rem;">üìÇ Import AGENT.md</button>
    </div>
    <div class="input-group"><label>Agent Name & Role:</label><input type="text" id="agent-name" placeholder="e.g. 'Nexus', The Orchestrator"></div>
    <div class="input-group"><label>Primary Goal:</label><textarea id="agent-goal" rows="2" placeholder="What is the main purpose of this agent?"></textarea></div>
    <div class="input-group"><label>Key Skills (Comma separated):</label><input type="text" id="agent-skills" placeholder="e.g. Web Search, Python Execution, File I/O"></div>

    <button id="generate-btn" onclick="generateAgent()"><span id="btn-text">Generate AGENT.md</span><div id="loader" class="loader"></div></button>
    <button id="stop-btn" class="stop-btn" onclick="stopGeneration()">Stop Generation</button>

    <div class="output-area" id="output-container" style="display:none;">
        <button class="save-btn" onclick="saveToFile()">Save File</button>
        <div id="thinking-container" style="display:none;">
            <div class="thinking-header" onclick="toggleThinking()">Reasoning Process</div>
            <div id="thinking-content" class="thinking-box"></div>
        </div>
        <label>AGENT.md Content:</label>
        <textarea id="result-output" rows="20"></textarea>
    </div>
</div>

<script>
    const SYSTEM_PROMPT = `You are an expert AI Systems Architect. 
    Your goal is to define a robust AI Agent in a structured Markdown format (AGENT.md).
    
    Based on the user's input, generate a file with these sections:
    1. **Identity**: Name, Role, and a brief "Backstory" or personality description.
    2. **Mission**: The primary objective and success criteria.
    3. **Capabilities**: A detailed list of skills this agent possesses.
    4. **Constraints**: Rules the agent must follow (e.g., "Never delete files without confirmation").
    5. **Interaction Style**: How the agent communicates (e.g., "Concise", "Socratic").`;

    let abortController = null;

    window.onload = async () => {
        await loadModels(getConfig());
    };

    async function generateAgent() {
        const globalConfig = getConfig();
        const name = document.getElementById('agent-name').value;
        const goal = document.getElementById('agent-goal').value;
        const skills = document.getElementById('agent-skills').value;
        const model = document.getElementById('model-select').value;

        if (!name || !goal) return alert("Please fill in Name and Goal.");

        const btn = document.getElementById('generate-btn');
        const loader = document.getElementById('loader');
        const out = document.getElementById('output-container');
        const thinkBox = document.getElementById('thinking-container');
        const thinkContent = document.getElementById('thinking-content');
        const resArea = document.getElementById('result-output');
        const stopBtn = document.getElementById('stop-btn');

        btn.disabled = true; document.getElementById('btn-text').style.display = 'none'; loader.style.display = 'block';
        stopBtn.style.display = 'block';
        resArea.value = ""; thinkContent.textContent = ""; thinkBox.style.display = 'none'; out.style.display = 'block';

        abortController = new AbortController();
        
        const messages = [
            { role: "system", content: SYSTEM_PROMPT },
            { role: "user", content: `Name: ${name}\nGoal: ${goal}\nSkills: ${skills}\n\nGenerate the AGENT.md content.` }
        ];
        const config = {
            ...globalConfig,
            model: model
        };

        let isThinking = false;

        await generateText(messages, config,
            (content) => {
                if (!isThinking && content.includes('<think>')) {
                    isThinking = true; thinkBox.style.display = 'block';
                    const parts = content.split('<think>');
                    if(parts[0]) resArea.value += parts[0]; if(parts[1]) thinkContent.textContent += parts[1];
                } else if (isThinking && content.includes('</think>')) {
                    isThinking = false;
                    const parts = content.split('</think>');
                    if(parts[0]) thinkContent.textContent += parts[0]; if(parts[1]) resArea.value += parts[1];
                } else if (isThinking) { thinkContent.textContent += content; thinkContent.scrollTop = thinkContent.scrollHeight;
                } else { resArea.value += content; resArea.scrollTop = resArea.scrollHeight; }
            },
            () => { // onComplete
                btn.disabled = false; document.getElementById('btn-text').style.display = 'inline'; loader.style.display = 'none'; stopBtn.style.display = 'none'; abortController = null;
            },
            (err) => { // onError
                if (err.name !== 'AbortError') alert("Error: " + err.message);
                else resArea.value += "\n\n[Generation stopped by user]";
                btn.disabled = false; document.getElementById('btn-text').style.display = 'inline'; loader.style.display = 'none'; stopBtn.style.display = 'none';
            },
            abortController.signal
        );
    }

    function stopGeneration() {
        if (abortController) abortController.abort();
    }

    function toggleThinking() {
        const h = document.querySelector('.thinking-header'); const c = document.getElementById('thinking-content');
        h.classList.toggle('collapsed'); c.style.display = h.classList.contains('collapsed') ? 'none' : 'block';
    }

    function saveToFile() {
        const content = document.getElementById('result-output').value;
        if (!content) return alert("Nothing to save!");

        const agentNameInput = document.getElementById('agent-name').value;
        // Sanitize filename: take first part before comma, replace spaces with underscores
        const safeAgentName = agentNameInput.split(',')[0].trim().replace(/[\s\/]/g, '_');
        const filename = safeAgentName ? `${safeAgentName}_AGENT.md` : 'AGENT.md';

        const blob = new Blob([content], { type: 'text/markdown;charset=utf-8' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
    }

    function loadAgentFile(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            parseAgentMarkdown(content);
        };
        reader.readAsText(file);
        input.value = ''; // Reset so same file can be selected again
    }

    function parseAgentMarkdown(md) {
        // Populate the output area first so the user can see the full content
        document.getElementById('result-output').value = md;
        document.getElementById('output-container').style.display = 'block';

        let nameFound = false;

        // 1. Try to find "Identity" section and extract Name
        const idMatch = md.match(/(?:#+|\*\*|\d+\.)\s*Identity.*?(?:\n|$)([\s\S]*?)(?=(?:#+|\*\*|\d+\.)\s*Mission|$)/i);
        if (idMatch) {
            const identityContent = idMatch[1];
            // Look for explicit "Name:" field
            const nameLineMatch = identityContent.match(/(?:-|\*|\d+\.)?\s*(?:\*\*)?Name:?(?:\*\*)?\s*(.+)/i);
            
            if (nameLineMatch) {
                document.getElementById('agent-name').value = nameLineMatch[1].trim();
                nameFound = true;
            } else {
                let rawId = identityContent.trim();
                let firstLine = rawId.split('\n')[0].replace(/[-*]\s+/, '').replace(/\*\*/g, '').replace(/Name:\s*/i, '');
                if (firstLine) { document.getElementById('agent-name').value = firstLine.trim(); nameFound = true; }
            }
        }

        // 2. If not found in Identity, try H1 header (ignoring generic filenames)
        if (!nameFound) {
            const h1Match = md.match(/^#\s+(.+)$/m);
            if (h1Match) {
                const h1Text = h1Match[1].trim();
                if (!h1Text.toLowerCase().includes('agent.md')) {
                    document.getElementById('agent-name').value = h1Text;
                }
            }
        }

        // 2. Mission/Goal
        const missionMatch = md.match(/(?:#+|\*\*|\d+\.)\s*Mission.*?(?:\n|$)([\s\S]*?)(?=(?:#+|\*\*|\d+\.)\s*Capabilities|$)/i);
        if (missionMatch) {
            document.getElementById('agent-goal').value = missionMatch[1].trim();
        }

        // 3. Skills
        const capsMatch = md.match(/(?:#+|\*\*|\d+\.)\s*Capabilities.*?(?:\n|$)([\s\S]*?)(?=(?:#+|\*\*|\d+\.)\s*Constraints|$)/i);
        if (capsMatch) {
            // Clean up bullets and newlines to make it comma-separated
            let rawSkills = capsMatch[1];
            let skills = rawSkills.replace(/^[-*]\s+/gm, '').split('\n').map(s => s.trim()).filter(s => s).join(', ');
            document.getElementById('agent-skills').value = skills;
        }
    }
</script>
</body>
</html>