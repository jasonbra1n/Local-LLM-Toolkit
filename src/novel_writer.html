<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novel Writer</title>
    <link rel="stylesheet" href="style.css">
    <script src="utils.js"></script>
    <script src="layout.js"></script>
    <style>
        :root {
            --accent-color: #f5c2e7; /* Pink for Creativity/Prose */
            --button-hover: #eba0ac;
        }
        .container { max-width: 1000px; }
    </style>
</head>
<body>
<div class="container">
    <h1>‚úçÔ∏è Novel Writer</h1>
    <!-- Status Bar -->
    <div class="status-bar">
        <div><span id="status-dot" class="status-indicator"></span><span id="status-text">Checking LM Studio...</span></div>
        <div style="font-size: 0.8em; opacity: 0.7;">Target: 127.0.0.1:1234</div>
    </div>

    <div class="info-box">
        <strong>‚ÑπÔ∏è Workflow:</strong> Paste your <strong>Story Bible / Chapter Outline</strong> (from the Story Architect) into the Context box. Then, specify which chapter you want to write today.
    </div>

    <!-- Inputs -->
    <div class="input-group">
        <label>Select Model:</label>
        <select id="model-select"><option value="local-model">Loading...</option></select>
    </div>

    <div class="input-group">
        <label>Story Context (Paste your Outline/Bible here):</label>
        <textarea id="context-input" rows="6" placeholder="Paste the output from Story Architect here..."></textarea>
    </div>

    <div class="row input-group">
        <div class="col">
            <label>Chapter / Scene to Write:</label>
            <input type="text" id="chapter-focus" placeholder="e.g. Chapter 1: The Discovery">
        </div>
        <div class="col">
            <label>Writing Style:</label>
            <input type="text" id="style-input" placeholder="e.g. Fast-paced, Atmospheric, First-person">
        </div>
    </div>

    <!-- Controls -->
    <button id="generate-btn" onclick="writeChapter()">
        <span id="btn-text">Write Chapter</span>
        <div id="loader" class="loader"></div>
    </button>
    <button id="stop-btn" class="stop-btn" onclick="stopGeneration()">Stop Generation</button>

    <!-- Output -->
    <div class="output-area" id="output-container" style="display:none;">
        <button class="save-btn" onclick="saveToFile()">Save Chapter</button>
        <button class="copy-btn" onclick="copyToClipboard()">Copy</button>
        <button class="speak-btn" onclick="speakOutput()" style="margin-right: 5px;">üîä Listen</button>
        <div id="thinking-container" style="display:none;">
            <div class="thinking-header" onclick="toggleThinking()">Reasoning Process</div>
            <div id="thinking-content" class="thinking-box"></div>
        </div>
        <label>Draft Prose:</label>
        <textarea id="result-output" rows="25"></textarea>
    </div>
</div>

<script>
    // Config & System Prompt
    const WRITER_PROMPT = `You are a best-selling Novelist.
    Your task is to write the prose for a specific chapter based on the provided Story Bible/Outline.
    
    Guidelines:
    1. **Show, Don't Tell**: Use sensory details and strong imagery.
    2. **Dialogue**: Write natural, character-driven dialogue.
    3. **Pacing**: Adhere to the requested writing style.
    4. **Context**: Ensure consistency with the provided character profiles and plot outline.
    5. **Output**: Write ONLY the story prose. Do not include meta-commentary.`;

    let abortController = null;

    // Window Load (Connection Check)
    window.onload = async () => {
        await loadModels(getConfig());
    };

    // Generate Function
    async function writeChapter() {
        const globalConfig = getConfig();
        const context = document.getElementById('context-input').value;
        const chapter = document.getElementById('chapter-focus').value;
        const style = document.getElementById('style-input').value;
        const model = document.getElementById('model-select').value;

        if (!context || !chapter) return alert("Please provide the Story Context and Chapter focus.");

        // UI Setup
        const btn = document.getElementById('generate-btn');
        const loader = document.getElementById('loader');
        const out = document.getElementById('output-container');
        const resArea = document.getElementById('result-output');
        const thinkBox = document.getElementById('thinking-container');
        const thinkContent = document.getElementById('thinking-content');
        const stopBtn = document.getElementById('stop-btn');

        btn.disabled = true; document.getElementById('btn-text').style.display = 'none'; loader.style.display = 'block'; stopBtn.style.display = 'block';
        out.style.display = 'block'; resArea.value = ""; thinkContent.textContent = ""; thinkBox.style.display = 'none';
        
        abortController = new AbortController();

        const userMessage = `Story Context:\n${context}\n\nTask: Write ${chapter}\nStyle: ${style || "Standard"}`;
        const messages = [{ role: "system", content: WRITER_PROMPT }, { role: "user", content: userMessage }];
        
        const config = {
            ...globalConfig,
            model: model
        };

        let isThinking = false;

        await generateText(messages, config,
            (content) => {
                if (!isThinking && content.includes('<think>')) {
                    isThinking = true; thinkBox.style.display = 'block';
                    const parts = content.split('<think>');
                    if(parts[0]) resArea.value += parts[0]; if(parts[1]) thinkContent.textContent += parts[1];
                } else if (isThinking && content.includes('</think>')) {
                    isThinking = false;
                    const parts = content.split('</think>');
                    if(parts[0]) thinkContent.textContent += parts[0]; if(parts[1]) resArea.value += parts[1];
                } else if (isThinking) { thinkContent.textContent += content; thinkContent.scrollTop = thinkContent.scrollHeight;
                } else { resArea.value += content; resArea.scrollTop = resArea.scrollHeight; }
            },
            () => { // onComplete
                btn.disabled = false; document.getElementById('btn-text').style.display = 'inline'; loader.style.display = 'none'; stopBtn.style.display = 'none'; abortController = null;
            },
            (err) => { // onError
                if (err.name !== 'AbortError') alert("Error: " + err.message);
                btn.disabled = false; document.getElementById('btn-text').style.display = 'inline'; loader.style.display = 'none'; stopBtn.style.display = 'none';
            },
            abortController.signal
        );
    }

    function stopGeneration() { 
        if (abortController) abortController.abort(); 
        stopSpeech();
    }
    function toggleThinking() {
        const h = document.querySelector('.thinking-header'); const c = document.getElementById('thinking-content');
        h.classList.toggle('collapsed'); c.style.display = h.classList.contains('collapsed') ? 'none' : 'block';
    }
    function copyToClipboard() {
        const copyText = document.getElementById("result-output");
        copyText.select(); navigator.clipboard.writeText(copyText.value); alert("Copied!");
    }
    function saveToFile() {
        const content = document.getElementById('result-output').value;
        if (!content) return alert("Nothing to save!");
        const chapter = document.getElementById('chapter-focus').value.replace(/[^a-zA-Z0-9]/g, '_') || "Chapter";
        const blob = new Blob([content], { type: 'text/markdown;charset=utf-8' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${chapter}.md`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    function speakOutput() {
        const btn = document.querySelector('.speak-btn');
        if (btn.innerText.includes("Stop")) {
            stopSpeech();
            btn.innerText = "üîä Listen";
            return;
        }
        const text = document.getElementById('result-output').value;
        if(!text) return;
        btn.innerText = "‚èπÔ∏è Stop";
        speakText(text, () => btn.innerText = "üîä Listen");
    }
</script>
</body>
</html>